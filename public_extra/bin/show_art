#!/usr/bin/env python3
# Senan Kelly 2016
# pip install --user python-mpd2

from contextlib import suppress
from mpd import MPDClient
from shutil import copyfile, rmtree
import os
import subprocess
import sys


def get_mpd_path(host, port):
    client = MPDClient()
    client.connect(host, port)
    mpd_path = client.currentsong()['file']
    client.close()
    client.disconnect()
    return os.path.dirname(mpd_path)


def get_art_file(mpd_root, mpd_path):
    full_path = os.path.join(mpd_root, mpd_path)
    for file in os.listdir(full_path):
        if 'folder.' in file:
            return os.path.join(full_path, file)


def show_art(art_file, size=50, x_pos=33, y_pos=33):
    ''' show art in urxvt-backgronud
        https://www.freebsd.org/cgi/man.cgi?query=urxvt&sektion=7
    '''
    format_string = '\e]20;{art_file};{size}x{size}+{x_pos}+{y_pos}:op=keep-aspect\a'
    subprocess.Popen(['/usr/bin/printf', format_string.format(**locals())])


def move_art(art_file, directory):
    with suppress(FileExistsError):
        os.makedirs(directory)
    copyfile(art_file, os.path.join(directory, 'folder.jpg'))


if __name__ == '__main__':

    if len(sys.argv) != 4:
        print('args should be <mpd_root> <host> <port>')
        sys.exit(1)

    mpd_root, host, port = sys.argv[1:]
    with suppress(Exception):
        mpd_path = get_mpd_path(host, port)
        art_file = get_art_file(mpd_root, mpd_path)
        move_art(art_file, '/tmp/ncmpcpp_art')
