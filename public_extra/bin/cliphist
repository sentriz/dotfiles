#!/usr/bin/env bash

# senan kelly 2019
#
# to start the deamon (listens for new items in the clipboard):
# $ ./cliphist listen
#
# to copy an old item to your clipboard example:
# $ ./cliphist select | dmenu -l 10 | ./cliphist copy

if [[ "$#" -ne 1 ]]; then
    echo "usage $0 [listen|select|copy]" >&2
    exit 1
fi

if ! which "wl-copy" > /dev/null 2>&1; then
    echo "please install wl-clipboard" >&2
    exit 1
fi

hist_dir=~/.local/share
hist_path="$hist_dir/cliphist"
hist_sep='â€¦'
last_copy=

function __listen_body () {
    copy="$(wl-paste --type text 2> /dev/null)"
    [[ -z "$copy" ]] && return
    [[ "$copy" == "$last_copy" ]] && return
    paste --serial --delimiters "$hist_sep" - <<< "$copy" >> "$hist_path"
    last_copy="$copy"
}

function __listen () {
    mkdir -p "$hist_dir" > /dev/null 2>&1
    rm "$hist_path" > /dev/null 2>&1
    while :; do
        __listen_body
	sleep 0.75
    done
}

function __select () {
    tac "$hist_path"
}

function __copy () {
    cat - \
        | tr "$hist_sep" '\n' \
        | wl-copy --trim-newline
}

case "$1" in
    listen) __listen ;;
    select) __select ;;
    copy)   __copy ;;
    *)      echo "invalid command \"$1\"" >&2
	    exit 1 ;;
esac
