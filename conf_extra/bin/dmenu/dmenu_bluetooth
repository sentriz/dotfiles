#!/usr/bin/env bash

if ! which bluetoothctl >/dev/null 2>&1; then
    echo "please install bluez-utils" >&2
    exit 1
fi

lower() {
    tr '[:upper:]' '[:lower:]'
}

notify_file="$(mktemp)"
notify() {
    notify-send.sh --replace-file "$notify_file" "$@"
}

devices="$(bluetoothctl devices | lower)"
device="$(printf "%s\n" "$devices" "disconnect" | dmenu_custom -p 'bluetooth')"
test -z "$device" && exit 1

device_name="$(cut -d ' ' -f 3- <<< "$device")"
device_mac="$(awk '{print $2}' <<< "$device")"

run_disconnect() {
    notify "disconnecting bluetooth"
    bluetoothctl disconnect
    notify "disconnecting done"
}

run_connect() {
    notify "connecting to $device_name"
    if ! out=$(bluetoothctl connect "${device_mac}"); then
        notify "connecting failed" "$out"
        return 1
    fi
    notify "connecting done"
}

test "$device" = "disconnect" && run_disconnect && exit
run_connect
