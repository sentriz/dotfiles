#!/usr/bin/env bash

# requires:
# - glib2 (dbus)
# - hsphfpd

function introspect() {
    gdbus introspect \
        --system \
        --dest "org.hsphfpd" \
        --object-path "/org/hsphfpd/hci0" \
        --recurse \
        --only-properties
}

function filter-parse() {
    q_bat="BatteryLevel = (-?[0-9]+)"
    q_conn="Connected = true"
    q_name="Name = '([^']+)'"
    sed -rnz "s/.*${q_bat}[^\}]*${q_conn}[^\}]*${q_name}.*/\L\1\t\2/gp"
}

IFS=$'\t' read -r battery device < <(introspect | filter-parse)
test \( -n "$device" \) -a \( "$battery" -gt 0 \) && exec echo "bluetooth $device, $battery%"
test \( -n "$device" \)                           && exec echo "bluetooth $device"
