#!/usr/bin/env bash

# requires:
# - playerctl

function lower() { tr '[:upper:]' '[:lower:]'; }
function truncate() { sed -E 's/(.{40})(.{1,})$/\1…/'; }
function pctl() { playerctl --ignore-player chromium,chrome,qutebrowser,firefox "$@"; }

function print-status() {
    title="$(pctl metadata title)"
    test -z "$title" && echo && return

    status="$(pctl status | lower)"
    title_short="$(truncate <<<"$title")"
    echo "$status ‘${title_short}’"
}

# kill potentially existing blocks (if restarting sway etc)
killall playerctl

# whenever the status or title changes, print an update
{
    pctl --follow status &
    pctl --follow metadata title
} | while read -r; do
    print-status
done &

# whenever the button is clicked, toggle playback and print an update
while read -r button; do
    case "$button" in
    1) pctl play-pause >/dev/null 2>&1 ;; # left click
    3) pctl stop >/dev/null 2>&1 ;;       # right click
    esac
    print-status
done
