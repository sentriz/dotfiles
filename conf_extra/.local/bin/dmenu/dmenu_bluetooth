#!/usr/bin/env bash

if ! type -p bluetoothctl >/dev/null; then
    echo "please install bluez-utils" >&2
    exit 1
fi

function lower() {
    tr '[:upper:]' '[:lower:]'
}

replace_file="$(mktemp)"
function notify() {
    notify-send.sh --replace-file "$replace_file" "$1" "$(strip-escape <<<"${@:2}" | lower)"
}

devices="$(bluetoothctl devices | lower)"
test -z "$devices" && exit 1

device="$(printf "%s\n" "$devices" "disconnect" | dmenu_custom bluetooth)"
test -z "$device" && exit 1

device_mac="$(cut -d ' ' -f 2 <<<"$device")"
device_name="$(cut -d ' ' -f 3- <<<"$device")"

if test "$device" = "disconnect"; then
    bluetoothctl -- disconnect >/dev/null 2>&1
    exit
fi

notify "bluetooth $device_name" "$(bluetoothctl -- power on)"
sleep 0 && notify "bluetooth $device_name" "$(bluetoothctl -- connect "$device_mac")"
sleep 1 && notify "bluetooth $device_name" "$(bluetoothctl -- connect "$device_mac")"
sleep 2 && notify "bluetooth $device_name" "$(bluetoothctl -- connect "$device_mac")"
sleep 3 && notify "bluetooth $device_name" "$(bluetoothctl -- connect "$device_mac")"
