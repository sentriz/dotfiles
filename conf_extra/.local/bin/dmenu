#!/usr/bin/env bash
# shellcheck disable=SC2064

pid_file="$XDG_CACHE_HOME/dmenu-pid"
lock_file="$XDG_CACHE_HOME/dmenu-lock"

kill "$(cat "$pid_file")" 2>/dev/null &

exec 9>"$lock_file"
flock 9 || exit 1

trap 'kill $(jobs -p) 2>/dev/null' EXIT

prompt="$1"
column="$2"

dir="$(mktemp --directory --tmpdir="$XDG_CACHE_HOME")"
trap 'rm -r "$dir"' EXIT

in="$dir/in"
out="$dir/out"

mkfifo "$in" "$out"

command=("fzf" "--prompt" "'$prompt '")
if test -n "$column"; then
    command+=("--delimiter" "$'\t'" "--with-nth" "$column" "--tabstop" "1")
fi

"$TERMINAL" --app-id launcher sh -c "theme light; ${command[*]} <$in >$out" 2>/dev/null &
echo $! >"$pid_file"

cat <"$out" &
cat >"$in"

wait
