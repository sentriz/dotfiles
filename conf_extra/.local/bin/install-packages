#!/usr/bin/env bash
# shellcheck disable=SC2046

set -e

export GIT_CONFIG_GLOBAL=/dev/null

if ! type -p yay >/dev/null; then
    sudo pacman -S --needed git base-devel
    git clone "https://aur.archlinux.org/yay-bin.git" /tmp/yay
    cd /tmp/yay || exit
    makepkg -si
    cd -
fi

function list() {
    grep -Po "^$1:\K.*" "$XDG_CONFIG_HOME/packages"
}

yay --version
yay -S --needed $(list arch)

python3 -m ensurepip
python3 -m pip --version
python3 -m pip install --user --disable-pip-version-check --no-input $(list python)

cargo version
cargo install $(list cargo)

go version
for package in $(list go); do
    go install "$package"
done

npm version
npm install -g $(list npm)

flatpak --version
flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak remote-add --user --if-not-exists flathub-beta https://flathub.org/beta-repo/flathub-beta.flatpakrepo
flatpak install --user --noninteractive --assumeyes flathub $(list flatpak)
flatpak install --user --noninteractive --assumeyes flathub-beta $(list flatpak-beta)
