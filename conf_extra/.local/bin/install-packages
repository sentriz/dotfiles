#!/usr/bin/env bash
# shellcheck disable=SC2046

set -e

export GIT_CONFIG_GLOBAL=/dev/null

if ! type -p yay >/dev/null; then
    sudo pacman -S --needed git base-devel
    git clone "https://aur.archlinux.org/yay-bin.git" /tmp/yay
    cd /tmp/yay || exit
    makepkg -si

    sudo pacman-key --recv-key FBA220DFC880C036 --keyserver keyserver.ubuntu.com
    sudo pacman-key --lsign-key FBA220DFC880C036
    sudo pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
    sudo tee -a /etc/pacman.conf <<-EOF
        [multilib]
        Include = /etc/pacman.d/mirrorlist
        [chaotic-aur]
        Include = /etc/pacman.d/chaotic-mirrorlist
EOF
    sudo pacman -Syu

    cd -
fi

function list() {
    grep -Po "^$1\s+\K.*" "$XDG_CONFIG_HOME/packages"
}

wanted=("${@:1}")
function want() {
    [[ "${#wanted[@]}" == 0 ]] && return
    for w in "${wanted[@]}"; do
        [[ "$w" == "$1" ]] && return
    done
    return 1
}

if want arch; then
    yay --version
    yay -S --needed --noconfirm $(list arch)
fi

if want python; then
    python3 -m ensurepip
    python3 -m pip --version
    python3 -m pip install --user --update --disable-pip-version-check --no-input $(list python)
fi

if want cargo; then
    cargo version
    cargo install $(list cargo)
fi

if want go; then
    go version
    for package in $(list go); do
        go install "$package"
    done
fi

if want npm; then
    npm version
    npm install -g $(list npm)
fi

if want flatpak; then
    flatpak --version
    flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    flatpak remote-add --user --if-not-exists flathub-beta https://flathub.org/beta-repo/flathub-beta.flatpakrepo
    flatpak install --user --noninteractive --assumeyes flathub $(list flatpak)
    flatpak install --user --noninteractive --assumeyes flathub-beta $(list flatpak-beta)
fi
