#!/usr/bin/env fish

set -l command "$argv[1]"
if test "$command" = stop
    killall --signal SIGINT wf-recorder
    exit
end

set -l filename "$DOTS_RECORDINGS_DIR/"(date '+%Y%m%d_%H%M%S.mp4')

contains -- --monitor $argv
and set -l slurp_cmd -o

set -l area (slurp $slurp_cmd)
test -z "$area"; and exit

set -l audio_device (pactl list short sources | grep -Po "\K[^\s]+\.monitor(?=.*IDLE)")
test -n "$audio_device"
and contains -- --audio $argv
and set -l audio_cmd "-a$audio_device"

wf-recorder $audio_cmd -f "$filename" -g "$area" --force-yuv >/dev/null 2>&1
echo "$filename"
