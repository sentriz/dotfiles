#!/usr/bin/env bash

pidof -q bluetoothd || exit 0

function notify() {
    notify-send --hint "string:x-dunst-stack-tag:$0" "$1" "$(strip-escape <<<"${@:2}")"
}

if [[ "$#" -gt 0 ]]; then
    device="$1"
    connected=
    [[ "$1" != "$device" ]] && connected=1

    IFS=$'\t' read -r mac name <<<"$device"

    if [[ -n "$connected" ]]; then
        bluetoothctl -- disconnect "$mac" >/dev/null 2>&1
        exit
    fi

    notify "bluetooth $name" "$(bluetoothctl -- power on)"
    notify "bluetooth $name" "$(bluetoothctl -- connect "$mac" | grep -v "^\[")"

    exit
fi

connected="$(bluetoothctl devices Connected | lower)"

highlight=$'\x1b]6366;highlight\x07'

bluetoothctl devices | grep "^D" | lower | while IFS=" " read -r _ mac name; do
    pre=""
    [[ -n "$connected" && "$connected" == *"$mac"* ]] && pre="$highlight"
    printf "%s%s\t%s\n" "$pre" "$mac" "$name"
done
