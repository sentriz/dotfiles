#!/usr/bin/env bash

pidof -q bluetoothd || exit 0

function notify() {
    notify-send --hint "string:x-dunst-stack-tag:$0" "$1" "$(strip-escape <<<"${@:2}")"
}

readarray -t connected_macs < <(bluetoothctl devices Connected | lower | col " " 2)

if [[ "$#" -gt 0 ]]; then
    IFS=$'\t' read -r mac name <<<"$1"

    if [[ "${connected_macs[*]}" =~ $mac ]]; then
        bluetoothctl -- disconnect "$mac" >/dev/null 2>&1
        exit
    fi

    notify "bluetooth $name" "$(bluetoothctl -- power on)"
    notify "bluetooth $name" "$(bluetoothctl -- connect "$mac" | grep -v "^\[")"

    exit
fi

highlight=$'\x1b]6366;highlight\x07'

bluetoothctl devices | grep "^D" | lower | while IFS=" " read -r _ mac name; do
    pre=""
    [[ "${connected_macs[*]}" =~ $mac ]] && pre="$highlight"
    printf "%s%s\t%s\n" "$pre" "$mac" "$name"
done
