#!/usr/bin/env bash

function notify() {
    notify-send --hint "string:x-dunst-stack-tag:$0" "$1" "$(strip-escape <<<"${@:2}" | lower)"
}

connected_pre="> "

if [[ "$#" -gt 0 ]]; then
    device="$1"
    device=${device#"$connected_pre"}

    device_mac="$(cut -d ' ' -f 2 <<<"$device")"
    device_name="$(cut -d ' ' -f 3- <<<"$device")"

    if test "$device" = "disconnect"; then
        bluetoothctl -- disconnect >/dev/null 2>&1
        exit
    fi

    notify "bluetooth $device_name" "$(bluetoothctl -- power on)"
    notify "bluetooth $device_name" "$(bluetoothctl -- connect "$device_mac" | grep -v "^\[")"

    exit
fi

current_device_mac="$(bluetoothctl info | grep -Po "^Device \K[^ ]{17}")"

bluetoothctl devices | grep "^Device " | while read -r line; do
    pre=""
    if [[ -n "$current_device_mac" && "$line" == *"$current_device_mac"* ]]; then
        pre="$connected_pre"
    fi
    echo "$pre$line"
done | lower

echo "disconnect"
