#!/usr/bin/env bash

playing_pre="> "

pid_file="$XDG_CACHE_HOME/mpv_radio_pid"

IFS=$'\t' read -r current_pid current_station <"$pid_file" 2>/dev/null
if [[ -n "$current_pid" ]] && ! kill -0 "$current_pid" 2>/dev/null; then
    current_pid=""
    current_station=""
    rm "$pid_file"
fi

if [[ "$#" -gt 0 ]]; then
    [[ "$current_pid" -gt 0 ]] && kill "$current_pid"

    station="$1"
    station="${station//$playing_pre/}"

    if [[ "$station" = "$current_station" ]]; then
        rm "$pid_file"
        exit
    fi

    mpv \
        --no-ytdl \
        --no-video \
        --no-cache \
        --quiet \
        --force-media-title="$station" \
        --no-resume-playback \
        "$DOTS_RADIO_DIR/$station" &
    echo -e "$!\t$station" >"$pid_file"
    notify-send 'started radio station' "$station"

    exit
fi

find \
    "$DOTS_RADIO_DIR" \
    -maxdepth 1 \
    -not -name '.st*' \
    -type f \
    -printf "%f\n" | while read -r line; do
    pre=""
    if [[ "$line" = "$current_station" ]]; then
        pre="$playing_pre"
    fi
    echo "${pre}$line"
done
