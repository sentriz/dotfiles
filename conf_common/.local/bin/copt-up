#!/usr/bin/env bash

copt="$DOTS_COPT_DIR"
exclude="$copt/.up-ignore"

function list-paths() {
    find "$copt" -maxdepth 2 -type d | grep --invert-match --file "$exclude"
}

echo -e "\n> pull repos"
list-paths | while read -r path; do
    (
        cd "$path" || exit
        git rev-parse 2>/dev/null || exit

        echo "  > pulling $path"
        git pull
    )
done

echo -e "\n> up projects"
list-paths | while read -r path; do
    (
        [[ "$path" =~ _src$ ]] && exit
        [[ "$path" =~ src$ ]] && exit

        cd "$path" || exit
        [[ -e "docker-compose.yml" ]] || exit

        echo "  > uping $path"
        docker compose pull
        docker compose up -d --build --remove-orphans
    )
done
